{% extends "!page.html" %}
{{ super() }}

{% block extrahead %}
<!-- Google Tag Manager -->
<script>
(function (w, d, s, l, i) {
    w[l] = w[l] || [];
    w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
    var f = d.getElementsByTagName(s)[0],
        j = d.createElement(s),
        dl = l != "dataLayer" ? "&l=" + l : "";
    j.async = true;
    j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
    f.parentNode.insertBefore(j, f);
})(window, document, "script", "dataLayer", "GTM-WC8V9XS");
</script>
<!-- End Google Tag Manager -->
<!-- UnionAI docs variant switcher -->
<script>
document.addEventListener("DOMContentLoaded", function() {

    // Variant of the current page.
    // e.g., 'serverless'
    const currentVariant = document.getElementById('unionai-docs-current-variant').textContent;;

    // Available variants of the current page (including the current page).
    // e.g., '["serverless", "byoc"]
    const availableVariants = document.getElementById('unionai-docs-available-variants').textContent;

    // Object mapping variant name to display name
    // e.g., {'serverless': 'Serverless', 'byoc': 'BYOC'}
    const variantDisplayNames = JSON.parse(document.getElementById('unionai-docs-variant-display-names').textContent);

    // List of all variants (globally, not just this page)
    const m = new Map(Object.entries(variantDisplayNames));
    const allVariants = Array.from(m.keys());

    // URL of current page
    // e.g., 'https://docs.unionai.com/serverless/guide/'
    const currentUrl = new URL(window.location.href);

    // Current URL in segments
    // e.g., ['serverless', 'guide']
    const currentUrlSegments = currentUrl.pathname.split('/').filter(Boolean);

    // Index of the current variant in the URL segments
    // e.g., 0
    const variantIndexInUrl = currentUrlSegments.indexOf(currentVariant);

    // An array of variant link objects, one for each variant (globally not just variants of the current page).
    // Each object has the following properties:
    //
    // * text: The display name of the variant represented by this object
    //   (e.g., "Serverless" or "BYOC").
    //
    // * url: The URL of the current page in this variant,
    //   if it exists (e.g., "https://docs.unionai.com/serverless/guide",
    //   "https://docs.unionai.com/byoc/guide") the top of the website in
    //   this variant (e.g., "https://docs.unionai.com/serverless/"
    //   or "https://docs.unionai.com/byoc/")
    const variantLinks = [];

    // For each variant, fill in text, peerUrl, and topUrl for the current page
    // and add it to the variant_links object.
    allVariants.forEach(variant => {

        // Get the URL segments in the current URL that come before the variant segment
        const prefixSegments = currentUrlSegments.slice(0, variantIndexInUrl);

        // Get the URL segments in the current URL that come after the variant segment
        const suffixSegments = currentUrlSegments.slice(variantIndexInUrl + 1);

        // Construct the top and peer URLs
        const topUrlSegments = prefixSegments.concat([variant]);
        const peerUrlSegments = prefixSegments.concat([variant], suffixSegments);
        const topUrl = new URL(currentUrl);
        topUrl.pathname = '/' + topUrlSegments.join('/');
        const peerUrl = new URL(currentUrl);
        peerUrl.pathname = '/' + peerUrlSegments.join('/');

        // Create a variant link object
        const variantLink = {};

        // Set the variantLink text to the display name of the variant
        variantLink.text = variantDisplayNames[variant];

        // If the variant is available for the current page, set the variantLink URL
        // to the peerURL, otherwise set it to the topURL
        if (availableVariants.includes(variant)) {
            variantLink.peerUrl = peerUrl.href;
        } else {
            variantLink.peerUrl = topUrl.href;
        }

        // Add the variant link to the list of variant links
        variantLinks.push(variantLink);
    });

    // Insert the variant links into the dropdown menu
    dropdownLinkContainers = document.getElementsByClassName('variant-selector-links');
    for (let container of dropdownLinkContainers) {
        variantLinks.forEach(variantLink => {
            const anchor = document.createElement('a');
            anchor.textContent = variantLink.text;
            anchor.href = variantLink.url;
            container.appendChild(anchor);
        })
    }

    // Insert the name of the current variant into the dropdown menu button
    dropdownTextContainers = document.getElementsByClassName('variant-selector-button')
    for (let container of dropdownTextContainers) {
        container.textContent = variantDisplayNames[currentVariant];
    }
})

</script>
<!-- End UnionAI docs variant switcher -->
{% endblock %}

{% block body %}
{%- if meta is mapping %}
    <div id="unionai-docs-variant-display-names" style="display: none;">{{ meta.get("variant-display-names") }}</div>
    <div id="unionai-docs-available-variants" style="display: none;">{{ meta.get("available-variants") }}</div>
    <div id="unionai-docs-current-variant" style="display: none;">{{ meta.get("current-variant") }}</div>
{%- endif %}
{{ super() }}

<!-- Google Tag Manager (noscript) -->
<noscript
  ><iframe
    src="https://www.googletagmanager.com/ns.html?id=GTM-WC8V9XS"
    height="0"
    width="0"
    style="display: none; visibility: hidden"
  ></iframe
></noscript>
<!-- End Google Tag Manager (noscript) -->
{% endblock %}
